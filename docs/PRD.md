# Lifeboard (라이프보드) PRD

## 핵심 정보

**목적**: 인생의 모든 데이터를 한눈에 볼 수 있는 통합 대시보드. 뉴스, 날씨, 메모, 일정 등 다양한 정보를 한 곳에서 관리하고 빠르게 파악할 수 있는 개인 라이프 허브
**사용자**: 일상의 다양한 정보를 효율적으로 관리하고 한눈에 파악하고 싶은 개인 사용자
**프로덕션**: https://lifeboard-omega.vercel.app
**GitHub**: https://github.com/ovlae6252-a11y/lifeboard

---

## 현재 상태 (v1.0 - MVP 완료)

### 완료된 기능

MVP (Phase 0~5)가 2026-02-16에 완료되었다. 현재 프로덕션에서 운영 중이다.

| ID       | 기능명              | 상태                                      | 설명                                                                   |
| -------- | ------------------- | ----------------------------------------- | ---------------------------------------------------------------------- |
| **F001** | RSS 뉴스 수집       | 완료                                      | 12개 한국 언론사 RSS 피드 자동 수집 (Vercel Cron, 하루 2회)            |
| **F002** | 중복 기사 그룹핑    | 완료                                      | pg_trgm 트라이그램 유사도 0.6 기반 배치 그룹핑 (RPC)                   |
| **F003** | AI 팩트 요약        | 완료                                      | Ollama PC 워커가 자동 처리 (qwen2.5:14b, Realtime + 폴링)              |
| **F004** | 뉴스 카테고리 필터  | 완료                                      | 7개 카테고리 탭 (전체/정치/경제/사회/생활문화/IT과학/세계)             |
| **F005** | 뉴스 그룹 카드 표시 | 완료                                      | 팩트 요약 불릿 포인트 + 관련 기사 링크 + 상대시간                      |
| **F006** | 뉴스 대시보드 섹션  | 완료                                      | 대시보드 메인에 최신 뉴스 6개 카드 표시                                |
| **F010** | 기본 인증           | 완료 (v1.1에서 소셜 로그인으로 대체 예정) | 이메일/비밀번호 회원가입, 로그인, 로그아웃 (Supabase Auth)             |
| **F011** | 수집 로그 관리      | 완료                                      | 소스별 수집 성공/실패 로그 + 자동 정리 (90일 로그, 30일 완료 작업)     |
| **F012** | 반응형 레이아웃     | 완료                                      | 모바일 햄버거 메뉴(Sheet) + 태블릿/데스크톱 네비게이션                 |
| -        | 페이지네이션        | 완료                                      | URL 기반 오프셋 페이지네이션 (?page=N), 페이지당 20개                  |
| -        | 에러/빈 상태 처리   | 완료                                      | 에러 바운더리, 로딩 스켈레톤, 카테고리별 빈 상태 메시지                |
| -        | 성능 최적화         | 완료                                      | `use cache` + RPC 배치 호출 + 캐시 태그 무효화 + Vercel Speed Insights |
| -        | 데이터 자동 정리    | 완료                                      | `cleanup_old_records` RPC (90일 로그, 30일 완료 작업)                  |

### 현재 아키텍처

```
[Vercel Cron 하루 2회 (KST 08:00, 20:00)]
  |
  v
[/api/news/collect] -- RSS 파싱 --> [Supabase DB]
  |                                      |
  |-- 배치 그룹핑 (RPC) --------------->|
  |-- 요약 작업 등록 (RPC) ------------>|-- summarize_jobs (큐)
  |-- 캐시 무효화 (updateTag) -------->|        |
                                        |        v
                                        |  [Ollama PC 워커]
                                        |    Realtime + 30s 폴링
                                        |    qwen2.5:14b 팩트 추출
                                        |        |
                                        |<-------| fact_summary 저장
                                        |
[Next.js 웹앱] <-- use cache + admin 클라이언트 -- [Supabase DB]
```

### 현재 라우팅 구조

| 경로                    | 목적                                      | 인증        |
| ----------------------- | ----------------------------------------- | ----------- |
| `/`                     | 공개 랜딩 페이지                          | 불필요      |
| `/auth/login`           | 로그인 (v1.1에서 소셜 전용으로 변경 예정) | 불필요      |
| `/auth/sign-up`         | 회원가입 (v1.1에서 제거 예정)             | 불필요      |
| `/auth/forgot-password` | 비밀번호 재설정 (v1.1에서 제거 예정)      | 불필요      |
| `/auth/update-password` | 비밀번호 변경 (v1.1에서 제거 예정)        | 불필요      |
| `/auth/confirm`         | 이메일 OTP 검증 (v1.1에서 제거 예정)      | 불필요      |
| `/protected`            | 대시보드 메인                             | 필수        |
| `/protected/news`       | 뉴스 전체 목록                            | 필수        |
| `/api/news/collect`     | RSS 수집 API                              | CRON_SECRET |

---

## 기술 스택

| 영역                  | 기술                     | 버전/비고                                               |
| --------------------- | ------------------------ | ------------------------------------------------------- |
| 프론트엔드 프레임워크 | Next.js (App Router)     | 16 (Turbopack, cacheComponents)                         |
| UI 라이브러리         | React                    | 19                                                      |
| 언어                  | TypeScript               | 5 (strict)                                              |
| 스타일링              | Tailwind CSS             | 4 (CSS 변수 기반 테마, OKLCH)                           |
| UI 컴포넌트           | shadcn/ui                | new-york 스타일                                         |
| 아이콘                | Lucide React             | -                                                       |
| 다크모드              | next-themes              | class 방식                                              |
| 폰트                  | next/font/google         | Libre Baskerville + Noto Sans KR + Lora + IBM Plex Mono |
| BaaS                  | Supabase (@supabase/ssr) | 인증, DB, RLS, Realtime                                 |
| 데이터베이스          | PostgreSQL               | Supabase 호스팅, pg_trgm                                |
| AI                    | Ollama (qwen2.5:14b)     | 로컬 LLM, 별도 PC 상주 워커                             |
| RSS 파싱              | rss-parser               | npm 패키지                                              |
| 배포                  | Vercel                   | Cron 작업, Speed Insights                               |
| 코드 품질             | ESLint + Prettier        | Husky + lint-staged (pre-commit)                        |
| 패키지 관리           | npm                      | -                                                       |

---

## 사용자 여정 (현재 + 목표)

```
1. [홈 페이지 /]
   ↓ 로그인 필요 → 자동 리다이렉트

2. [로그인 페이지 /auth/login]
   ↓ 소셜 로그인 (v1.1)

3. [대시보드 메인 /protected]                    ← 현재: 뉴스 섹션만 존재
   - 최신 뉴스 카드 6개 (대표이미지 + 제목만, F108)
   - (v1.1) 날씨 위젯
   - (v1.2) 빠른 메모
   - (v2.0) 일정 요약, 할일 목록, 재무 요약...
   ↓ 뉴스 카드 클릭 → 뉴스 상세 페이지 (F109)
   ↓ 각 섹션 "더보기" → 전체 목록 페이지

4. [뉴스 /protected/news]                        ← 현재 완료
   - 간소화된 카드 목록 (F108)
   - 카테고리 탭 필터링 + 페이지네이션
   - (v1.1) 검색, 북마크
   ↓ 카드 클릭

5. [뉴스 상세 /protected/news/[groupId]]        ← v1.1 신규 (F109)
   - 대표 기사 제목 + 메타정보
   - 통일된 팩트 요약 폼 (F110)
   - 관련 기사 전체 목록
   - 북마크, 공유 버튼 (F102, F106)
   ↓ 뒤로가기 → 뉴스 목록

6. (v1.1) [날씨 /protected/weather]              ← 신규 예정
   - 현재 날씨 + 주간 예보

7. (v1.1) [설정 /protected/settings]             ← 신규 예정 (F103)
   - 프로필, 선호 카테고리, 위젯 설정, 뉴스 소스 관리

8. (v1.2) [메모 /protected/memos]                ← 신규 예정
   - 빠른 메모 작성/관리

9. (v2.0) [일정, 할일, 재무...]                  ← 장기 예정

--- 관리자 전용 여정 (role === 'admin') ---

10. [관리자 패널 /admin]                         ← v1.1 신규 (F120~F125)
    - 헤더의 "관리자" 링크 또는 사용자 메뉴에서 진입
    - 별도 사이드바 레이아웃 (일반 사용자 네비게이션과 분리)

11. [관리자 대시보드 /admin]                      ← v1.1 신규 (F121)
    - 시스템 현황 개요 (사용자, 기사, 요약 통계)
    - 파이프라인 상태 + 품질 지표
    - 최근 활동 로그

12. [뉴스 관리 /admin/news]                       ← v1.1 신규 (F122)
    - 소스 CRUD + 그룹 관리 + 기사 관리 (탭 구성)

13. [콘텐츠 모더레이션 /admin/moderation]         ← v1.1 신규 (F123)
    - 필터 규칙 관리 + 품질 검토 큐 (탭 구성)

14. [사용자 관리 /admin/users]                    ← v1.1 신규 (F124)
    - 사용자 목록, 역할 변경, 계정 상태 관리

15. [시스템 모니터링 /admin/monitoring]            ← v1.1 신규 (F125)
    - 수집 로그 + 요약 작업 + 시스템 상태 (탭 구성)
```

---

## v1.1 기능 명세 - 소셜 로그인 + 뉴스 고도화 + 날씨 + 관리자 시스템

> **목표**: 인증 시스템을 소셜 로그인으로 전환하고, 뉴스 시스템의 실용성을 높이며, 두 번째 라이프 데이터(날씨)를 추가하고, 관리자 시스템을 구축하여 서비스 운영 기반을 확립한다.

### 신규 기능

| ID       | 기능명               | 설명                                                                                             | 우선순위 | 관련 페이지            |
| -------- | -------------------- | ------------------------------------------------------------------------------------------------ | -------- | ---------------------- |
| **F100** | 소셜 로그인          | Google, Kakao 계정으로 로그인. 기존 이메일/비밀번호 인증 제거. Naver는 v1.2로 이관 (OIDC 미지원) | Must     | 로그인 페이지          |
| **F101** | 뉴스 검색            | 제목/요약 기반 전문 검색 (PostgreSQL FTS 또는 trgm LIKE)                                         | Must     | 뉴스 페이지            |
| **F102** | 뉴스 북마크          | 관심 뉴스 그룹 저장/해제, 북마크 목록 조회                                                       | Must     | 뉴스 페이지, 대시보드  |
| **F103** | 사용자 설정 페이지   | 프로필 정보 확인, 선호 카테고리 설정, 대시보드 위젯 순서 설정                                    | Must     | 설정 페이지            |
| **F104** | 날씨 위젯            | 현재 날씨 + 시간별/주간 예보 표시. 기상청 공공 API 활용                                          | Should   | 대시보드, 날씨 페이지  |
| **F105** | 뉴스 소스 관리       | RSS 소스 활성/비활성 토글, 새 소스 추가 (관리자 기능)                                            | Should   | 설정 페이지            |
| **F106** | 뉴스 공유            | 뉴스 그룹 링크 복사, 팩트 요약 텍스트 복사                                                       | Could    | 뉴스 페이지            |
| **F107** | 대시보드 위젯 시스템 | 대시보드 섹션을 위젯 단위로 관리. 표시/숨김 토글, 순서 변경                                      | Should   | 대시보드               |
| **F108** | 뉴스 카드 UI 간소화  | 목록 화면에서 대표이미지 + 제목만 표시 (네이버뉴스 스타일)                                       | Must     | 뉴스 페이지, 대시보드  |
| **F109** | 뉴스 상세 페이지     | 클릭 시 상세 페이지로 이동, 팩트 요약 + 관련 기사 전체 표시                                      | Must     | 뉴스 상세 페이지       |
| **F110** | 통일된 팩트 요약 폼  | 상세 페이지에서 일관된 레이아웃으로 팩트 요약 표시                                               | Must     | 뉴스 상세 페이지       |
| **F111** | AI 요약 품질 관리    | 한국어 전용 요약 강제, 품질 검증 실패 시 목록에서 숨김                                           | Must     | 전체                   |
| **F112** | 그룹핑 시스템 개선   | 유사도 임계값 조정 (0.6→0.5), 수집 소스 확대, 그룹핑 범위 확장                                   | Should   | 백엔드 파이프라인      |
| **F113** | 콘텐츠 필터링        | 연예인 일상/경조사 등 불필요 기사 키워드 필터링 (AI 또는 규칙 기반)                              | Should   | 백엔드 파이프라인      |
| **F120** | 관리자 역할 시스템   | Supabase custom claims 기반 관리자 역할 관리. 관리자 전용 라우트 보호                            | Must     | 전체 (관리자 영역)     |
| **F121** | 관리자 대시보드      | 시스템 현황 요약 (수집 통계, 요약 현황, 사용자 수, 에러율). 실시간 파이프라인 상태               | Must     | 관리자 대시보드        |
| **F122** | 뉴스 관리            | 뉴스 소스 CRUD, 그룹 관리(숨김/노출/병합), AI 요약 재실행, 기사 삭제                             | Must     | 관리자 뉴스 관리       |
| **F123** | 콘텐츠 모더레이션    | 콘텐츠 필터 규칙 관리 UI, AI 요약 품질 검토 큐, 수동 품질 승인/거부                              | Should   | 관리자 콘텐츠 관리     |
| **F124** | 사용자 관리          | 사용자 목록 조회/검색, 역할 변경, 계정 상태 관리 (활성/정지)                                     | Should   | 관리자 사용자 관리     |
| **F125** | 시스템 모니터링      | 수집 로그 뷰어, Ollama 워커 상태, 에러 로그, Cron 작업 이력                                      | Should   | 관리자 시스템 모니터링 |

### F100: 소셜 로그인 (Google, Kakao)

**문제**: 현재 이메일/비밀번호 방식은 사용자에게 계정 생성 부담을 준다. 비밀번호 분실, 이메일 인증 대기 등 마찰이 크다. 대부분의 사용자는 이미 소셜 계정을 보유하고 있으므로, 소셜 로그인만으로 간편하게 서비스를 이용할 수 있어야 한다.

**해결**: Google, Kakao 2개 소셜 로그인 프로바이더를 지원하고, 기존 이메일/비밀번호 인증 시스템을 완전히 제거한다.

> **Naver 로그인은 v1.2로 이관**: Naver는 OIDC를 지원하지 않아(순수 OAuth 2.0만 제공) Supabase 네이티브/커스텀 OIDC 방식이 불가능하다. Supabase Edge Function을 통한 커스텀 토큰 교환이 필요하여 복잡도가 높으므로 별도 버전에서 구현한다.

#### 기존 사용자 마이그레이션 전략

| 항목            | 내용                                                                                                       |
| --------------- | ---------------------------------------------------------------------------------------------------------- |
| **기존 계정**   | 이메일/비밀번호 사용자에게 소셜 로그인 전환 안내. 동일 이메일의 소셜 계정 자동 링킹 (Supabase 설정)        |
| **테스트 계정** | `test@lifeboard.dev` 테스트 계정은 소셜 로그인 전환 후 Supabase Admin API로 테스트 세션 생성 방식으로 변경 |
| **E2E 테스트**  | Playwright E2E 테스트는 Supabase `auth.admin.createUser()` + 직접 세션 주입 방식으로 전환                  |
| **전환 기간**   | 이메일 로그인은 환경변수 플래그(`ALLOW_EMAIL_AUTH=true`)로 개발/테스트 환경에서만 유지 가능하게 설정       |

#### 소셜 프로바이더별 구현 방식

| 프로바이더 | Supabase 지원 | 구현 방식                                 | OAuth 콘솔           |
| ---------- | ------------- | ----------------------------------------- | -------------------- |
| **Google** | 네이티브      | `signInWithOAuth({ provider: 'google' })` | Google Cloud Console |
| **Kakao**  | 네이티브      | `signInWithOAuth({ provider: 'kakao' })`  | Kakao Developers     |

#### 로그인 페이지 (`/auth/login`) 변경

| 항목            | 내용                                                                                |
| --------------- | ----------------------------------------------------------------------------------- |
| **기존 UI**     | 이메일/비밀번호 입력 폼 + 회원가입 링크 + 비밀번호 찾기 링크                        |
| **변경 UI**     | 소셜 로그인 버튼 2개 표시 (Google, Kakao). 이메일/비밀번호 폼 완전 제거             |
| **레이아웃**    | 중앙 정렬 카드 내 Lifeboard 로고 + "소셜 계정으로 로그인" 안내 + 버튼 2개 세로 배치 |
| **버튼 디자인** | 각 프로바이더 공식 브랜드 가이드라인 준수 (색상, 로고, 텍스트)                      |
| **에러 처리**   | OAuth 실패 시 `/auth/error` 리다이렉트, 에러 메시지 한국어 표시                     |

#### OAuth 인증 흐름

```
1. 사용자가 로그인 페이지에서 소셜 버튼 클릭
   ↓
2. supabase.auth.signInWithOAuth({ provider, options: { redirectTo } })
   ↓
3. Supabase가 프로바이더 OAuth 동의 화면으로 리다이렉트
   ↓
4. 사용자가 프로바이더에서 로그인 + 권한 동의
   ↓
5. 프로바이더 → Supabase 콜백 (https://<project>.supabase.co/auth/v1/callback)
   ↓
6. Supabase가 사용자 생성/연결 + 세션 토큰 발급
   ↓
7. /auth/callback Route Handler에서 code → session 교환
   ↓
8. /protected (대시보드)로 리다이렉트
```

#### 제거되는 페이지/컴포넌트

| 구분         | 제거 대상                             | 이유                        |
| ------------ | ------------------------------------- | --------------------------- |
| **페이지**   | `/auth/sign-up`                       | 소셜 로그인으로 자동 가입   |
| **페이지**   | `/auth/forgot-password`               | 비밀번호 없음               |
| **페이지**   | `/auth/update-password`               | 비밀번호 없음               |
| **페이지**   | `/auth/sign-up-success`               | 이메일 확인 불필요          |
| **페이지**   | `/auth/confirm` (OTP Route Handler)   | 이메일 OTP 불필요           |
| **컴포넌트** | `login-form.tsx` (이메일/비밀번호 폼) | 소셜 로그인 컴포넌트로 대체 |
| **컴포넌트** | `sign-up-form.tsx`                    | 회원가입 폼 불필요          |
| **컴포넌트** | `forgot-password-form.tsx`            | 비밀번호 찾기 불필요        |
| **컴포넌트** | `update-password-form.tsx`            | 비밀번호 변경 불필요        |

#### 신규/변경 파일

| 구분     | 파일                                  | 내용                                                                     |
| -------- | ------------------------------------- | ------------------------------------------------------------------------ |
| **신규** | `components/social-login-buttons.tsx` | 소셜 로그인 버튼 3개 (Client Component)                                  |
| **신규** | `app/auth/callback/route.ts`          | OAuth 콜백 Route Handler (code → session 교환)                           |
| **변경** | `app/auth/login/page.tsx`             | 소셜 로그인 버튼만 표시                                                  |
| **변경** | `components/auth-button.tsx`          | 사용자 이름/아바타 표시 (이메일 대신)                                    |
| **변경** | `app/page.tsx` (홈)                   | 회원가입 버튼 제거, 로그인 버튼만 유지 또는 "시작하기" → 로그인으로 통합 |
| **변경** | `proxy.ts`                            | 허용 경로에 `/auth/callback` 추가                                        |

#### Supabase 대시보드 설정 (OAuth - `.env.local` 불필요)

OAuth 프로바이더 설정은 **Supabase 대시보드의 Authentication > Providers**에서 관리한다. `.env.local`에 추가하지 않는다.

| 프로바이더 | 설정 항목                  | 비고                          |
| ---------- | -------------------------- | ----------------------------- |
| Google     | Client ID, Client Secret   | Google Cloud Console에서 발급 |
| Kakao      | REST API 키, Client Secret | Kakao Developers에서 발급     |

#### Supabase 대시보드 설정

각 프로바이더별로 Supabase Dashboard > Authentication > Providers에서:

1. 프로바이더 활성화 (Enabled 토글)
2. Client ID / Secret 입력
3. Redirect URL 확인: `https://<project-ref>.supabase.co/auth/v1/callback`
4. 해당 URL을 각 프로바이더의 OAuth 콘솔에 등록

#### 사용자 프로필 데이터

소셜 로그인 시 프로바이더에서 받아오는 정보:

| 프로바이더 | 이메일   | 이름     | 프로필 이미지 | 비고                      |
| ---------- | -------- | -------- | ------------- | ------------------------- |
| Google     | O        | O        | O             | 기본 스코프에 포함        |
| Kakao      | O (선택) | O (선택) | O (선택)      | Kakao 동의 항목 설정 필요 |

`auth.users` 테이블의 `raw_user_meta_data` JSONB에 프로바이더 프로필 자동 저장됨. `auth-button.tsx`에서 이를 읽어 사용자 이름/아바타 표시.

#### v1.1 이후 라우팅 구조 (F100~F113 완료 후)

| 경로                        | 목적              | 인증        | 변경사항                  |
| --------------------------- | ----------------- | ----------- | ------------------------- |
| `/`                         | 공개 랜딩 페이지  | 불필요      | CTA 버튼 통합             |
| `/auth/login`               | 소셜 로그인       | 불필요      | 소셜 버튼만 표시          |
| `/auth/callback`            | OAuth 콜백 처리   | 불필요      | **신규**                  |
| `/auth/error`               | 인증 에러 표시    | 불필요      | 유지                      |
| `/protected`                | 대시보드 메인     | 필수        | 카드 UI 간소화 (F108)     |
| `/protected/news`           | 뉴스 전체 목록    | 필수        | 카드 UI 간소화 (F108)     |
| `/protected/news/[groupId]` | 뉴스 상세 페이지  | 필수        | **신규** (F109)           |
| `/protected/settings`       | 사용자 설정       | 필수        | **신규** (F103)           |
| `/protected/weather`        | 날씨 상세 페이지  | 필수        | **신규** (F104)           |
| `/api/news/collect`         | RSS 수집 API      | CRON_SECRET | 콘텐츠 필터링 추가 (F113) |
| `/admin`                    | 관리자 대시보드   | 관리자 필수 | **신규** (F121)           |
| `/admin/news`               | 뉴스 관리         | 관리자 필수 | **신규** (F122)           |
| `/admin/moderation`         | 콘텐츠 모더레이션 | 관리자 필수 | **신규** (F123)           |
| `/admin/users`              | 사용자 관리       | 관리자 필수 | **신규** (F124)           |
| `/admin/monitoring`         | 시스템 모니터링   | 관리자 필수 | **신규** (F125)           |
| `/api/admin/*`              | 관리자 전용 API   | 관리자 필수 | **신규** (F120~F125)      |

> **제거**: `/auth/sign-up`, `/auth/forgot-password`, `/auth/update-password`, `/auth/sign-up-success`, `/auth/confirm`

### F101: 뉴스 검색

**문제**: 현재 뉴스는 카테고리 필터와 페이지네이션만 제공한다. 특정 키워드나 주제를 찾으려면 모든 페이지를 일일이 살펴봐야 한다.

**해결**: 뉴스 페이지 상단에 검색바를 추가하여, 제목과 팩트 요약 내용을 기반으로 뉴스 그룹을 검색할 수 있게 한다.

| 항목            | 내용                                                                                                                          |
| --------------- | ----------------------------------------------------------------------------------------------------------------------------- |
| **사용자 행동** | 검색바에 키워드 입력 → 엔터 또는 검색 버튼 클릭 → 결과 표시                                                                   |
| **검색 범위**   | `news_article_groups.fact_summary` + `news_articles.title` (대표 기사)                                                        |
| **검색 방식**   | `pg_trgm` ILIKE 검색 (프로젝트에서 이미 pg_trgm 확장 사용 중). PostgreSQL 한국어 FTS는 built-in 사전이 없으므로 사용하지 않음 |
| **URL 연동**    | `/protected/news?q=검색어&category=economy` (카테고리 필터와 병행 가능)                                                       |
| **빈 결과**     | "검색 결과가 없습니다" 메시지 + 다른 키워드 제안                                                                              |
| **DB 변경**     | `news_article_groups.fact_summary` + `news_articles.title`에 `pg_trgm` GIN 인덱스 추가                                        |
| **향후 개선**   | 검색 품질이 부족하면 Typesense/Meilisearch 등 외부 검색 엔진 도입 검토 (v2.0)                                                 |

### F102: 뉴스 북마크

**문제**: 관심 있는 뉴스를 나중에 다시 보고 싶어도, 현재 페이지를 벗어나면 찾기 어렵다.

**해결**: 뉴스 그룹 카드에 북마크 버튼을 추가하고, 북마크한 뉴스를 별도로 조회할 수 있게 한다.

| 항목            | 내용                                                                                             |
| --------------- | ------------------------------------------------------------------------------------------------ |
| **사용자 행동** | 뉴스 카드의 북마크 아이콘 클릭 → 즉시 저장/해제 (낙관적 UI 업데이트)                             |
| **표시 위치**   | 뉴스 페이지 탭에 "북마크" 탭 추가, 대시보드에 "북마크한 뉴스" 섹션 (선택)                        |
| **DB 변경**     | `user_bookmarks` 테이블 신규 (user_id, group_id, created_at). RLS: 본인 데이터만 CRUD            |
| **제한**        | 사용자당 최대 100개 (INSERT 전 API Route에서 COUNT 체크, 초과 시 에러 메시지)                    |
| **FK 정책**     | `user_id` ON DELETE CASCADE, `group_id` ON DELETE CASCADE (사용자/그룹 삭제 시 북마크 자동 정리) |

### F103: 사용자 설정 페이지

**문제**: 현재 사용자 프로필 확인이나 개인화 설정을 할 수 있는 페이지가 없다.

**해결**: `/protected/settings` 페이지를 추가하여 프로필, 선호 카테고리, 대시보드 설정 등을 관리한다.

| 항목           | 내용                                                                                                        |
| -------------- | ----------------------------------------------------------------------------------------------------------- |
| **경로**       | `/protected/settings`                                                                                       |
| **설정 항목**  | 프로필 정보 (이메일, 가입일), 선호 카테고리 선택 (복수 선택), 대시보드 위젯 순서/표시 설정                  |
| **DB 변경**    | `user_preferences` 테이블 신규 (user_id PK, preferred_categories JSONB, dashboard_config JSONB, updated_at) |
| **네비게이션** | 헤더의 사용자 아이콘/이름 드롭다운 메뉴에 "설정" 링크 추가                                                  |

### F104: 날씨 위젯

**문제**: 뉴스만으로는 "인생의 모든 데이터를 한눈에" 볼 수 있다는 가치를 제대로 전달할 수 없다. 두 번째 라이프 데이터를 추가해야 한다.

**해결**: 기상청 공공 API를 활용하여 현재 날씨와 예보를 대시보드 위젯으로 제공한다.

| 항목              | 내용                                                                                                                                                |
| ----------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| **데이터 소스**   | **OpenWeatherMap Free tier 권장** (JSON 응답, 위경도 직접 사용, 파싱 단순). 기상청 API는 격자 좌표 변환 + XML 파싱 + 코드 매핑 필요하여 복잡도 높음 |
| **대시보드 위젯** | 현재 온도, 날씨 상태 아이콘, 최고/최저 온도, 강수확률                                                                                               |
| **상세 페이지**   | `/protected/weather` - 시간별 예보 (24시간), 주간 예보 (7일)                                                                                        |
| **위치 설정**     | 사용자 설정에서 지역 선택 (시/도 단위) 또는 브라우저 Geolocation                                                                                    |
| **캐싱**          | 날씨 데이터는 30분~1시간 캐시 (`use cache`), API 호출 횟수 제한 대응                                                                                |
| **환경 변수**     | `WEATHER_API_KEY` (서버 전용)                                                                                                                       |

### F105: 뉴스 소스 관리

**문제**: RSS 소스 추가/비활성화가 DB 직접 수정으로만 가능하다.

**해결**: 설정 페이지에서 RSS 소스 목록 확인, 활성/비활성 토글, 새 소스 추가 기능을 제공한다. (초기에는 관리자 전용)

| 항목        | 내용                                                                                             |
| ----------- | ------------------------------------------------------------------------------------------------ |
| **경로**    | `/protected/settings` 내 "뉴스 소스" 탭                                                          |
| **기능**    | 소스 목록 조회, 활성/비활성 토글, 새 RSS URL 추가 (URL 유효성 검증), 카테고리 지정               |
| **권한**    | 관리자 전용 (F122 뉴스 관리에 통합)                                                              |
| **DB 변경** | 없음 (`news_sources` 테이블 기존 구조 활용, 관리자 API Route에서 service_role 클라이언트로 접근) |

> **참고**: F105는 F122 (관리자 뉴스 관리)의 소스 관리 탭에 통합한다. `/protected/settings`에는 뉴스 소스 관리를 포함하지 않는다.

### F106: 뉴스 공유

**문제**: 팩트 요약을 다른 사람에게 전달하려면 화면을 캡처하거나 수동으로 텍스트를 복사해야 한다.

**해결**: 뉴스 그룹 카드에 공유 버튼을 추가하여 링크 복사, 팩트 요약 텍스트 복사 기능을 제공한다.

| 항목          | 내용                                                                                                     |
| ------------- | -------------------------------------------------------------------------------------------------------- |
| **공유 방식** | 클립보드 복사 (Web Clipboard API): 팩트 요약 텍스트 복사, 뉴스 상세 페이지 URL 복사                      |
| **공유 링크** | `/protected/news/<groupId>` (뉴스 상세 페이지 URL). 비로그인 사용자는 로그인 후 해당 페이지로 리다이렉트 |
| **UI**        | 카드 우측 상단 공유 아이콘 → 드롭다운 메뉴 (요약 복사, 링크 복사)                                        |
| **토스트**    | 복사 완료 시 "클립보드에 복사되었습니다" 토스트 메시지                                                   |

### F107: 대시보드 위젯 시스템

**문제**: 대시보드에 섹션이 추가될수록 정보 과부하가 발생할 수 있다. 사용자마다 필요한 정보가 다르다.

**해결**: 대시보드의 각 섹션을 위젯 단위로 관리하여, 표시/숨김 토글과 순서 변경을 지원한다.

| 항목          | 내용                                                                                                      |
| ------------- | --------------------------------------------------------------------------------------------------------- |
| **위젯 목록** | 뉴스 위젯, 날씨 위젯 (v1.1), 메모 위젯 (v1.2), ...                                                        |
| **설정**      | `/protected/settings`에서 위젯 표시 여부 토글. v1.1에서는 고정 순서, 드래그앤드롭 순서 변경은 v1.2로 이관 |
| **저장**      | `user_preferences.dashboard_config` JSONB 컬럼에 위젯 ID + 표시 여부 저장                                 |
| **기본값**    | 신규 사용자는 모든 위젯 표시, 기본 순서 적용                                                              |

> **복잡도 절감**: 드래그앤드롭 순서 변경은 `@dnd-kit` 등 추가 라이브러리 + 모바일 터치 대응 + 접근성(keyboard reordering)이 필요하므로 v1.2로 이관. v1.1에서는 토글만 구현하여 복잡도를 "높음"에서 "낮음"으로 낮춘다.

### F108: 뉴스 카드 UI 간소화 (사용자 피드백)

**문제**: 현재 뉴스 카드는 팩트 요약 불릿 포인트 + 관련 기사 링크를 모두 표시하여 정보 밀도가 높고 한눈에 들어오지 않는다. 사용자는 네이버뉴스처럼 간단한 목록 형태를 선호한다.

**해결**: 뉴스 목록과 대시보드 위젯에서는 **대표이미지 + 제목만** 표시하고, 상세 내용은 클릭 후 상세 페이지에서 확인하도록 UI를 간소화한다.

| 항목            | 내용                                                                                              |
| --------------- | ------------------------------------------------------------------------------------------------- |
| **기존 UI**     | 카드: 제목 + 카테고리 + 팩트 요약 불릿 포인트 (3~5개) + 관련 기사 링크 목록 + 상대시간            |
| **변경 UI**     | 카드: 대표이미지 (16:9 또는 1:1) + 제목 + 카테고리 배지 + 기사 수 (N개 기사) + 상대시간           |
| **레이아웃**    | 좌측에 대표이미지 썸네일 (또는 상단), 우측에 메타 정보 + 제목 (모바일: 상단 이미지 + 하단 텍스트) |
| **상호작용**    | 카드 전체가 클릭 가능 영역 → `/protected/news/[groupId]` 상세 페이지로 이동                       |
| **이미지 소스** | 대표 기사의 OG 이미지 또는 기본 플레이스홀더 (언론사별 로고 또는 카테고리별 기본 이미지)          |

#### UI 컴포넌트 변경

| 파일                                         | 기존                            | 변경                                       |
| -------------------------------------------- | ------------------------------- | ------------------------------------------ |
| `components/news/news-group-card.tsx`        | 팩트 요약 + 관련 기사 링크 표시 | 대표이미지 + 제목만 표시, 카드 클릭 이벤트 |
| `components/news/news-dashboard-section.tsx` | 동일                            | 동일                                       |

#### 이미지 폴백 전략

대부분의 한국 언론사 RSS 피드에서 이미지를 제공하지 않을 수 있다.

| 우선순위 | 이미지 소스                          | 구현 방식                                         |
| -------- | ------------------------------------ | ------------------------------------------------- |
| 1        | `news_articles.image_url` (RSS 제공) | RSS `<enclosure>` 또는 `<media:content>`에서 수집 |
| 2        | 카테고리별 기본 이미지               | `public/images/categories/` 정적 에셋             |
| 3        | 이미지 없는 레이아웃                 | 제목 + 카테고리 배지만 표시 (텍스트 전용 모드)    |

> OG 이미지 크롤링은 추가 서버 부하와 복잡도가 높으므로 향후 개선사항으로 분리한다.

### F109: 뉴스 상세 페이지 (사용자 피드백)

**문제**: 현재 뉴스 목록에서 모든 정보를 한 번에 보여주려다 보니 가독성이 떨어진다. 관심 있는 뉴스의 상세 정보를 따로 확인할 방법이 없다.

**해결**: 뉴스 그룹 클릭 시 상세 페이지로 이동하여, 팩트 요약과 관련 기사 전체 목록을 보기 좋게 표시한다.

| 항목            | 내용                                                                                                                                                          |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **경로**        | `/protected/news/[groupId]` (동적 라우트)                                                                                                                     |
| **페이지 구성** | 상단: 대표 기사 제목 + 카테고리 + 기사 수 + 생성일시<br>중단: 팩트 요약 섹션 (통일된 폼, F110)<br>하단: 관련 기사 목록 (제목 + 언론사 + 발행시간 + 외부 링크) |
| **진입**        | 뉴스 목록 카드 클릭, 대시보드 위젯 카드 클릭                                                                                                                  |
| **뒤로가기**    | 브라우저 뒤로가기 또는 헤더 네비게이션                                                                                                                        |
| **공유**        | F106 (뉴스 공유) 기능 통합: 링크 복사, 팩트 요약 텍스트 복사                                                                                                  |
| **북마크**      | F102 (뉴스 북마크) 버튼 표시                                                                                                                                  |

#### 신규 파일

| 파일                                        | 내용                                    |
| ------------------------------------------- | --------------------------------------- |
| `app/protected/news/[groupId]/page.tsx`     | 뉴스 상세 페이지 (Server Component)     |
| `components/news/news-detail.tsx`           | 상세 페이지 레이아웃 (Server Component) |
| `components/news/fact-summary-card.tsx`     | 팩트 요약 카드 (통일된 폼)              |
| `components/news/related-articles-list.tsx` | 관련 기사 목록                          |

#### 데이터 쿼리

`lib/news/queries.ts`에 신규 함수 추가:

- `getNewsGroupDetail(groupId: string)` - 그룹 정보 + 대표 기사 + 팩트 요약
- `getRelatedArticles(groupId: string)` - 그룹 내 모든 관련 기사 목록 (정렬: 발행시간 최신순)

### F110: 통일된 팩트 요약 폼 (사용자 피드백)

**문제**: 현재 팩트 요약이 각 카드마다 다른 포맷으로 표시되어 가독성이 떨어진다. 사용자는 일관된 형식을 원한다.

**해결**: 상세 페이지의 팩트 요약 섹션에 통일된 디자인 시스템을 적용한다.

| 항목             | 내용                                                                                       |
| ---------------- | ------------------------------------------------------------------------------------------ |
| **레이아웃**     | 카드 컴포넌트 (shadcn/ui Card), 좌측에 "팩트 체크" 아이콘, 우측에 불릿 포인트 목록         |
| **타이포그래피** | 제목: font-semibold text-lg, 불릿 포인트: text-base leading-relaxed                        |
| **색상**         | 배경: card (라이트: white, 다크: warm slate), 텍스트: foreground, 아이콘: primary          |
| **불릿 스타일**  | 커스텀 불릿 (체크 아이콘 또는 점), 좌측 여백 일관성                                        |
| **빈 상태**      | 팩트 요약이 없거나 생성 중일 때: "AI 팩트 요약 생성 중입니다..." 스켈레톤 또는 안내 메시지 |

### F111: AI 요약 품질 관리 (사용자 피드백)

**문제**:

1. AI 요약이 중국어로 나오는 경우가 있음 (모델이 다국어를 섞어 출력)
2. 요약이 이상하거나 실패한 뉴스 그룹이 목록에 계속 노출됨

**해결**:

1. Ollama 프롬프트에 **"반드시 한국어로만 응답"** 명시 추가
2. 요약 완료 후 **한국어 검증 로직** 추가 (한글 비율 체크)
3. 품질 검증 실패 시 그룹을 **목록에서 숨김 처리** (soft delete 또는 `is_valid` 플래그)

| 항목              | 내용                                                                                                    |
| ----------------- | ------------------------------------------------------------------------------------------------------- |
| **프롬프트 수정** | 기존 프롬프트에 "**반드시 한국어로만 작성하세요. 다른 언어(영어, 중국어 등)를 섞지 마세요.**" 문구 추가 |
| **언어 검증**     | 요약 텍스트에서 한글 문자 비율 계산. 70% 미만이면 검증 실패 처리                                        |
| **품질 플래그**   | `news_article_groups` 테이블에 `is_valid` BOOLEAN 컬럼 추가 (기본값: true)                              |
| **숨김 처리**     | 검증 실패 시 `is_valid = false` 설정, 프론트엔드 쿼리에서 `WHERE is_valid = true` 필터 추가             |
| **재요약 기능**   | 관리자 UI에서 실패한 그룹 확인 + 수동 재요약 트리거 (선택 사항)                                         |

#### DB 마이그레이션

```sql
-- news_article_groups 테이블에 품질 플래그 추가
alter table news_article_groups
  add column is_valid boolean default true;

-- 기존 데이터는 모두 valid로 설정 (기본값)
-- 인덱스 추가 (쿼리 성능 향상)
create index idx_news_article_groups_is_valid
  on news_article_groups(is_valid)
  where is_valid = true;
```

#### Ollama 워커 변경

`scripts/summarizer.ts`:

- 한글 비율 검증 함수 추가 (`validateKoreanContent()`)
- 요약 완료 후 검증 실패 시 `is_valid = false` 업데이트
- 로그에 실패 사유 기록 (디버깅용)

#### 프론트엔드 쿼리 변경

`lib/news/queries.ts`의 `getNewsGroups()` 쿼리에 `is_valid` 필터 추가 필요:

```typescript
// 기존 쿼리에 .eq("is_valid", true) 추가
query = query.eq("is_valid", true);
```

영향 범위: `getNewsGroups()`, `getLatestNewsGroups()` (getNewsGroups 호출), `getNewsGroupArticles()`는 그룹 단위가 아니므로 변경 불필요.

> `database.types.ts`도 `is_valid` 컬럼 추가 후 `npx supabase gen types`로 재생성 필요.

### F112: 그룹핑 시스템 개선 (사용자 피드백)

**문제**: 대부분의 뉴스 그룹에 관련 기사가 1개뿐이어서 그룹핑의 의미가 없다. 유사한 기사들이 제대로 묶이지 않고 있다.

**해결**:

1. 유사도 임계값을 0.6에서 **0.5로 낮춰** 더 많은 기사가 그룹핑되도록 조정
2. RSS 수집 소스를 확대하여 동일 주제에 대한 기사 풀 증가
3. 그룹핑 시간 범위를 48시간에서 **72시간으로 확대**

| 항목              | 내용                                                                         |
| ----------------- | ---------------------------------------------------------------------------- |
| **유사도 임계값** | `batch_group_articles` RPC 함수 수정: 0.6 → 0.5                              |
| **시간 범위**     | 그룹핑 대상 범위: 48시간 → 72시간                                            |
| **추가 소스**     | 중앙일보, 조선일보, 서울신문 등 추가 (v1.1에서 10개 → 20개 소스로 확대)      |
| **수집 빈도**     | Vercel Pro 업그레이드 시 하루 2회 → 6회 (4시간 간격)로 증가                  |
| **모니터링**      | 수집 로그에서 평균 그룹당 기사 수 추적, 1.5개 미만이면 임계값 추가 조정 검토 |

#### RPC 함수 수정

`supabase/migrations/[timestamp]_update_grouping_threshold.sql`:

실제 함수 시그니처는 `batch_group_articles(p_articles jsonb, p_similarity_threshold float, p_hours_range int)`이므로, 기본값만 변경한다:

```sql
-- batch_group_articles 함수의 기본 파라미터 변경
-- 기존: p_similarity_threshold float default 0.6, p_hours_range int default 48
-- 변경: p_similarity_threshold float default 0.5, p_hours_range int default 72
create or replace function batch_group_articles(
  p_articles jsonb,
  p_similarity_threshold float default 0.5,  -- 0.6 → 0.5
  p_hours_range int default 72               -- 48 → 72
)
returns table (article_id uuid, group_id uuid, is_new_group boolean)
language plpgsql
security definer
as $$
  -- ... (나머지 로직 동일, 20260216000006_add_batch_group_articles_rpc.sql 참고)
$$;
```

### F113: 콘텐츠 필터링 (사용자 피드백)

**문제**: 연예인 일상, 유명인 경조사 등 사용자가 관심 없는 단순한 기사가 많이 수집된다.

**해결**:

1. **키워드 블랙리스트** 방식으로 불필요 기사 필터링
2. RSS 수집 시 제목에 특정 키워드가 포함되면 수집 단계에서 제외
3. (선택) AI 기반 카테고리 분류로 "연예/스포츠" 중 실질적 뉴스만 선별

| 항목           | 내용                                                                                                      |
| -------------- | --------------------------------------------------------------------------------------------------------- |
| **필터 방식**  | 키워드 블랙리스트 + 정규식 패턴 매칭                                                                      |
| **블랙리스트** | `["결혼", "이혼", "열애", "임신", "출산", "부고", "장례", "일상", "근황", "데이트", "SNS 인증"]` 등       |
| **적용 시점**  | RSS 수집 단계 (`/api/news/collect`), DB INSERT 전에 필터링                                                |
| **설정 관리**  | 환경 변수 또는 DB 테이블 (`content_filters`)로 관리, 관리자 UI에서 수정 가능 (F105 확장)                  |
| **로깅**       | 필터링된 기사 수를 `news_fetch_logs`에 기록 (`filtered_count` 컬럼 추가)                                  |
| **예외 처리**  | 중요 뉴스 누락 방지: 블랙리스트 단어가 있어도 "속보", "긴급", "공식" 등 화이트리스트 키워드가 있으면 수집 |

#### 구현 예시

`lib/news/content-filter.ts` (신규):

```typescript
const BLACKLIST_KEYWORDS = [
  "결혼",
  "이혼",
  "열애",
  "임신",
  "출산",
  "부고",
  "장례",
  "일상",
  "근황",
  "데이트",
  "SNS",
  "인스타",
  "패션",
  "공항",
];

const WHITELIST_KEYWORDS = ["속보", "긴급", "공식", "발표"];

export function shouldFilterArticle(title: string): boolean {
  const hasBlacklist = BLACKLIST_KEYWORDS.some((kw) => title.includes(kw));
  const hasWhitelist = WHITELIST_KEYWORDS.some((kw) => title.includes(kw));

  return hasBlacklist && !hasWhitelist;
}
```

### F120: 관리자 역할 시스템

**문제**: 현재 모든 인증 사용자가 동일한 권한을 가진다. 뉴스 소스 관리(F105), 콘텐츠 필터링(F113), AI 요약 품질 관리(F111) 등 운영 기능을 특정 관리자만 사용할 수 있어야 한다.

**해결**: Supabase custom claims를 활용하여 관리자 역할을 부여하고, 관리자 전용 라우트와 API를 보호한다.

| 항목            | 내용                                                                                                     |
| --------------- | -------------------------------------------------------------------------------------------------------- |
| **역할 구분**   | `user` (기본), `admin` (관리자). Supabase `auth.users`의 `raw_app_meta_data.role`에 저장                 |
| **역할 부여**   | 초기 관리자는 Supabase 대시보드에서 SQL로 직접 설정. 이후 관리자가 UI에서 다른 사용자에게 역할 부여 가능 |
| **권한 확인**   | 서버: `getClaims()`로 `app_metadata.role` 확인. 클라이언트: Supabase Auth 세션의 `app_metadata`에서 읽기 |
| **라우트 보호** | `proxy.ts`에서 `/admin/*` 경로 접근 시 관리자 역할 확인, 비관리자는 `/protected`로 리다이렉트            |
| **API 보호**    | 관리자 전용 API Route에서 `getClaims()` → `app_metadata.role === 'admin'` 검증                           |
| **RLS 정책**    | 관리자 전용 테이블/작업에 `auth.jwt() -> 'app_metadata' ->> 'role' = 'admin'` 조건 추가                  |

#### 초기 관리자 설정 SQL

```sql
-- 특정 사용자를 관리자로 설정
update auth.users
set raw_app_meta_data = raw_app_meta_data || '{"role": "admin"}'::jsonb
where email = 'admin@example.com';
```

#### 관리자 역할 확인 유틸리티

`lib/auth/admin.ts` (신규):

```typescript
import { createClient } from "@/lib/supabase/server";

export async function isAdmin(): Promise<boolean> {
  // getClaims()를 사용 (getSession()보다 빠름, 프로젝트 컨벤션 준수)
  const supabase = await createClient();
  const { data } = await supabase.auth.getClaims();
  return data?.claims?.app_metadata?.role === "admin";
}

export async function requireAdmin(): Promise<void> {
  const admin = await isAdmin();
  if (!admin) {
    throw new Error("관리자 권한이 필요합니다.");
  }
}
```

#### proxy.ts 변경 (lib/supabase/proxy.ts)

관리자 라우트 보호를 위해 `/admin/*` 경로 접근 시 역할 확인 로직 추가. **주의: `getClaims()`를 이중 호출하지 않고, 기존 39행의 호출 결과를 재사용한다.**

```typescript
// 기존 getClaims() 결과에서 role 추출 (이중 호출 금지)
const { data } = await supabase.auth.getClaims();
const user = data?.claims;

// /admin/* 경로 접근 시 관리자 역할 확인
if (request.nextUrl.pathname.startsWith("/admin")) {
  const role = user?.app_metadata?.role;
  if (!user || role !== "admin") {
    return NextResponse.redirect(new URL("/protected", request.url));
  }
}

// 기존 미인증 리다이렉트 로직 (변경 없음)
if (
  request.nextUrl.pathname !== "/" &&
  !user &&
  !request.nextUrl.pathname.startsWith("/login") &&
  !request.nextUrl.pathname.startsWith("/auth") &&
  !request.nextUrl.pathname.startsWith("/api")
) {
  // ...
}
```

### F121: 관리자 대시보드

**문제**: 시스템 상태를 파악하려면 Supabase 대시보드, Vercel 로그, DB 직접 조회를 번갈아 확인해야 한다. 운영에 필요한 핵심 지표를 한눈에 볼 수 없다.

**해결**: 관리자 전용 대시보드에서 시스템 현황, 파이프라인 상태, 주요 지표를 실시간으로 확인할 수 있게 한다.

| 항목                | 내용                                                                                                                               |
| ------------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| **경로**            | `/admin`                                                                                                                           |
| **시스템 개요**     | 총 사용자 수, 오늘 활성 사용자, 총 뉴스 그룹 수, 오늘 수집된 기사 수                                                               |
| **파이프라인 현황** | 마지막 수집 시간, 수집 성공/실패율, 대기 중인 요약 작업 수, 요약 완료율                                                            |
| **품질 지표**       | 유효하지 않은 요약 수 (`is_valid = false`), 평균 그룹당 기사 수, 필터링된 기사 수                                                  |
| **최근 활동**       | 최근 수집 로그 5건, 최근 요약 완료/실패 5건                                                                                        |
| **차트**            | 일별 기사 수집량 (7일), 카테고리별 기사 분포 (파이 차트). **shadcn/ui charts** 사용 (`npx shadcn@latest add chart`, Recharts 기반) |
| **새로고침**        | 자동 새로고침 30초 간격 (선택 사항) 또는 수동 새로고침 버튼                                                                        |

#### 데이터 쿼리

`lib/admin/queries.ts` (신규):

```typescript
// 시스템 통계 조회
export async function getSystemStats() {
  // auth.users 카운트 (service_role 필요)
  // news_article_groups 카운트, 오늘 수집 기사 카운트
  // summarize_jobs 상태별 카운트
  // news_fetch_logs 최근 기록
}

// 일별 수집 통계 (7일)
export async function getDailyCollectionStats(days: number = 7) { ... }

// 카테고리별 기사 분포
export async function getCategoryDistribution() { ... }
```

### F122: 뉴스 관리

**문제**: 뉴스 소스 추가/수정(F105), AI 요약 재실행(F111), 문제 있는 그룹/기사 처리를 위해 DB를 직접 조작해야 한다.

**해결**: 관리자 UI에서 뉴스 소스, 그룹, 기사를 직접 관리할 수 있는 종합 뉴스 관리 페이지를 제공한다.

| 항목        | 내용                            |
| ----------- | ------------------------------- |
| **경로**    | `/admin/news`                   |
| **탭 구성** | 소스 관리, 그룹 관리, 기사 관리 |

#### 소스 관리 탭 (`/admin/news?tab=sources`)

| 항목          | 내용                                                                                          |
| ------------- | --------------------------------------------------------------------------------------------- |
| **기능**      | 소스 목록 조회, 활성/비활성 토글, 새 RSS URL 추가, 소스 편집/삭제                             |
| **소스 추가** | RSS URL 입력 → URL 유효성 검증 (실제 RSS 피드인지 확인) → 언론사명, 카테고리 설정 → DB INSERT |
| **소스 편집** | 언론사명, 카테고리, URL 수정. 활성 상태 토글                                                  |
| **소스 상태** | 각 소스별 마지막 수집 시간, 최근 수집 성공/실패 횟수, 총 기사 수 표시                         |
| **관련 기능** | F105 (뉴스 소스 관리)를 관리자 전용으로 구현                                                  |

#### 그룹 관리 탭 (`/admin/news?tab=groups`)

| 항목            | 내용                                                                                    |
| --------------- | --------------------------------------------------------------------------------------- |
| **기능**        | 그룹 목록 조회 (필터: 카테고리, 유효성, 요약 상태), 그룹 숨김/노출 토글, AI 요약 재실행 |
| **그룹 숨김**   | `is_valid = false` 설정으로 프론트엔드에서 숨김 처리                                    |
| **요약 재실행** | 선택한 그룹의 요약 작업을 `summarize_jobs`에 재등록 (기존 fact_summary 초기화)          |
| **그룹 상세**   | 그룹 클릭 시 소속 기사 목록, 현재 팩트 요약, 요약 작업 이력 확인                        |
| **일괄 작업**   | 체크박스 선택 → 일괄 숨김/노출, 일괄 요약 재실행                                        |

#### 기사 관리 탭 (`/admin/news?tab=articles`)

| 항목          | 내용                                                      |
| ------------- | --------------------------------------------------------- |
| **기능**      | 기사 검색 (제목, 소스, 날짜 범위), 기사 삭제, 그룹 변경   |
| **기사 삭제** | 부적절한 기사 soft delete (또는 그룹에서 제거)            |
| **그룹 변경** | 잘못 그룹핑된 기사를 다른 그룹으로 이동 또는 새 그룹 생성 |

#### 신규/변경 파일

| 파일                                        | 내용                                   |
| ------------------------------------------- | -------------------------------------- |
| `app/admin/news/page.tsx`                   | 뉴스 관리 페이지 (Server Component)    |
| `components/admin/news-source-manager.tsx`  | 소스 관리 UI (Client Component)        |
| `components/admin/news-group-manager.tsx`   | 그룹 관리 UI (Client Component)        |
| `components/admin/news-article-manager.tsx` | 기사 관리 UI (Client Component)        |
| `app/api/admin/news/sources/route.ts`       | 소스 CRUD API                          |
| `app/api/admin/news/groups/route.ts`        | 그룹 관리 API (숨김/노출, 요약 재실행) |
| `app/api/admin/news/articles/route.ts`      | 기사 관리 API                          |

### F123: 콘텐츠 모더레이션

**문제**: AI 요약 품질이 불안정하고(F111), 콘텐츠 필터 규칙(F113) 변경이 DB 직접 수정으로만 가능하다. 품질 문제가 있는 콘텐츠를 체계적으로 검토/처리할 수 없다.

**해결**: 콘텐츠 필터 규칙을 UI에서 관리하고, AI 요약 품질을 검토할 수 있는 모더레이션 큐를 제공한다.

| 항목        | 내용                 |
| ----------- | -------------------- |
| **경로**    | `/admin/moderation`  |
| **탭 구성** | 필터 관리, 품질 검토 |

#### 필터 관리 탭 (`/admin/moderation?tab=filters`)

| 항목            | 내용                                                                |
| --------------- | ------------------------------------------------------------------- |
| **기능**        | 블랙리스트/화이트리스트 키워드 CRUD, 필터 규칙 활성/비활성 토글     |
| **키워드 추가** | 키워드 입력 + 필터 타입(블랙리스트/화이트리스트) 선택 → DB INSERT   |
| **테스트**      | 제목 입력 → 현재 필터 규칙으로 필터링 여부 테스트 (실시간 미리보기) |
| **통계**        | 필터별 차단된 기사 수, 최근 차단된 기사 제목 목록                   |
| **관련 기능**   | F113 (콘텐츠 필터링)의 관리 UI                                      |

#### 품질 검토 탭 (`/admin/moderation?tab=quality`)

| 항목            | 내용                                                                                     |
| --------------- | ---------------------------------------------------------------------------------------- |
| **기능**        | `is_valid = false`인 그룹 목록, 요약 실패 그룹 목록, 수동 승인/거부                      |
| **검토 큐**     | 자동 품질 검증 실패 항목이 큐에 추가됨. 관리자가 확인 후 승인(노출) 또는 거부(숨김 유지) |
| **수동 승인**   | `is_valid = true`로 변경하여 프론트엔드에 다시 노출                                      |
| **요약 재실행** | 품질 불량 그룹의 AI 요약을 재실행 트리거                                                 |
| **관련 기능**   | F111 (AI 요약 품질 관리)의 관리 UI                                                       |

#### 신규/변경 파일

| 파일                                        | 내용                               |
| ------------------------------------------- | ---------------------------------- |
| `app/admin/moderation/page.tsx`             | 콘텐츠 모더레이션 페이지           |
| `components/admin/filter-manager.tsx`       | 필터 관리 UI (Client Component)    |
| `components/admin/quality-review-queue.tsx` | 품질 검토 큐 UI (Client Component) |
| `app/api/admin/moderation/filters/route.ts` | 필터 규칙 CRUD API                 |
| `app/api/admin/moderation/quality/route.ts` | 품질 승인/거부 API                 |

### F124: 사용자 관리

**문제**: 사용자 정보 확인, 역할 변경, 문제 계정 처리를 위해 Supabase 대시보드에 직접 접근해야 한다.

**해결**: 관리자 UI에서 사용자 목록을 조회하고, 역할을 변경하고, 계정 상태를 관리할 수 있게 한다.

| 항목            | 내용                                                                                               |
| --------------- | -------------------------------------------------------------------------------------------------- |
| **경로**        | `/admin/users`                                                                                     |
| **사용자 목록** | 이메일, 이름, 가입일, 마지막 로그인, 역할(user/admin), 로그인 프로바이더 표시. 페이지네이션 + 검색 |
| **역할 변경**   | 사용자 선택 → 역할 변경 (user ↔ admin). 자기 자신의 역할은 변경 불가 (안전장치)                    |
| **계정 상태**   | 활성/정지 토글. 정지된 사용자는 로그인 불가 (Supabase `banned_until` 활용)                         |
| **사용자 상세** | 사용자 클릭 시 상세 정보: 프로필, 북마크 수, 설정, 활동 이력                                       |
| **통계**        | 총 사용자 수, 오늘 가입 수, 활성 사용자 수, 프로바이더별 분포                                      |

#### 데이터 조회

사용자 데이터는 `auth.users` 테이블에 있으므로 service_role 클라이언트로 조회한다:

```typescript
// lib/admin/queries.ts
export async function getUsers(page: number, search?: string) {
  const supabase = getSupabaseAdmin();
  const { data, error } = await supabase.auth.admin.listUsers({
    page,
    perPage: 20,
  });
  // 검색 필터링은 서버 측에서 수행
  return data;
}

export async function updateUserRole(userId: string, role: "user" | "admin") {
  const supabase = getSupabaseAdmin();
  const { error } = await supabase.auth.admin.updateUserById(userId, {
    app_metadata: { role },
  });
  return { error };
}
```

#### 신규/변경 파일

| 파일                                    | 내용                                   |
| --------------------------------------- | -------------------------------------- |
| `app/admin/users/page.tsx`              | 사용자 관리 페이지 (Server Component)  |
| `components/admin/user-list.tsx`        | 사용자 목록 UI (Client Component)      |
| `components/admin/user-detail.tsx`      | 사용자 상세 정보 UI (Client Component) |
| `app/api/admin/users/route.ts`          | 사용자 목록 조회 API                   |
| `app/api/admin/users/[userId]/route.ts` | 사용자 역할/상태 변경 API              |

### F125: 시스템 모니터링

**문제**: RSS 수집 실패, Ollama 워커 장애, 요약 작업 적체 등 시스템 문제를 빠르게 인지하고 대응할 수 없다. Vercel 로그와 Supabase 대시보드를 번갈아 확인해야 한다.

**해결**: 시스템 로그, 워커 상태, 에러 이력을 관리자 UI에서 통합 모니터링할 수 있게 한다.

| 항목        | 내용                              |
| ----------- | --------------------------------- |
| **경로**    | `/admin/monitoring`               |
| **탭 구성** | 수집 로그, 요약 작업, 시스템 상태 |

#### 수집 로그 탭 (`/admin/monitoring?tab=logs`)

| 항목          | 내용                                                                        |
| ------------- | --------------------------------------------------------------------------- |
| **기능**      | `news_fetch_logs` 테이블 조회. 소스별 필터, 날짜 범위 필터, 성공/실패 필터  |
| **표시 정보** | 수집 시간, 소스명, 수집 건수, 신규 건수, 필터링 건수, 에러 메시지 (실패 시) |
| **정렬**      | 최신순 기본, 페이지네이션                                                   |

#### 요약 작업 탭 (`/admin/monitoring?tab=jobs`)

| 항목          | 내용                                                                            |
| ------------- | ------------------------------------------------------------------------------- |
| **기능**      | `summarize_jobs` 테이블 조회. 상태별 필터 (pending/processing/completed/failed) |
| **표시 정보** | 작업 ID, 그룹 제목, 상태, 생성 시간, 완료 시간, 처리 소요 시간                  |
| **작업 관리** | 실패한 작업 재시도, 장기 processing 상태 작업 리셋 (pending으로 변경)           |
| **통계**      | 상태별 작업 수, 평균 처리 시간, 성공률                                          |

#### 시스템 상태 탭 (`/admin/monitoring?tab=system`)

| 항목           | 내용                                                                                        |
| -------------- | ------------------------------------------------------------------------------------------- |
| **파이프라인** | 마지막 Cron 실행 시간, 다음 예정 시간, 최근 실행 결과 (성공/실패)                           |
| **워커 상태**  | Ollama 워커 마지막 활동 시간 (summarize_jobs의 최근 completed/processing 타임스탬프로 추정) |
| **DB 상태**    | 주요 테이블별 레코드 수, 디스크 사용량 (Supabase API 활용 가능 시)                          |
| **정리 현황**  | 마지막 `cleanup_old_records` 실행 시간, 정리된 레코드 수                                    |

#### 신규/변경 파일

| 파일                                     | 내용                                      |
| ---------------------------------------- | ----------------------------------------- |
| `app/admin/monitoring/page.tsx`          | 시스템 모니터링 페이지 (Server Component) |
| `components/admin/fetch-log-viewer.tsx`  | 수집 로그 뷰어 (Client Component)         |
| `components/admin/job-manager.tsx`       | 요약 작업 관리 UI (Client Component)      |
| `components/admin/system-status.tsx`     | 시스템 상태 UI (Client Component)         |
| `app/api/admin/monitoring/logs/route.ts` | 수집 로그 조회 API                        |
| `app/api/admin/monitoring/jobs/route.ts` | 요약 작업 조회/관리 API                   |

#### 관리자 공통 레이아웃

`app/admin/layout.tsx` (신규):

```typescript
import { isAdmin } from "@/lib/auth/admin";
import { redirect } from "next/navigation";
import { AdminSidebar } from "@/components/admin/admin-sidebar";

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const admin = await isAdmin();
  if (!admin) redirect("/protected");

  return (
    <div className="flex min-h-screen">
      <AdminSidebar />
      <main className="flex-1 p-6">{children}</main>
    </div>
  );
}
```

`components/admin/admin-sidebar.tsx` (신규):

```
관리자 사이드바 네비게이션:
├── 대시보드 (/admin)
├── 뉴스 관리 (/admin/news)
├── 콘텐츠 모더레이션 (/admin/moderation)
├── 사용자 관리 (/admin/users)
├── 시스템 모니터링 (/admin/monitoring)
└── 사이트로 돌아가기 (/protected)
```

---

## v1.2 기능 명세 - 메모 + 알림 + 개인화 강화

> **목표**: 세 번째 라이프 데이터(메모)를 추가하고, 알림 시스템과 개인화 기능을 강화한다.

### 신규 기능

| ID       | 기능명                 | 설명                                                              | 우선순위 | 관련 페이지           |
| -------- | ---------------------- | ----------------------------------------------------------------- | -------- | --------------------- |
| **F201** | 빠른 메모              | 간단한 텍스트 메모 작성/편집/삭제, 대시보드 위젯에 최근 메모 표시 | Must     | 대시보드, 메모 페이지 |
| **F202** | 이메일 뉴스 다이제스트 | 매일 아침 요약된 뉴스를 이메일로 발송 (선호 카테고리 기반)        | Should   | 설정 페이지           |
| **F203** | 뉴스 트렌드            | 최근 24시간 내 가장 많이 보도된 주제(그룹) 순위 표시              | Should   | 뉴스 페이지, 대시보드 |
| **F204** | 해외 뉴스 RSS          | Reuters, AP News 등 영문 RSS 소스 추가, 영문 팩트 요약            | Could    | 뉴스 페이지           |
| **F205** | PWA 지원               | 모바일 홈 화면 추가, 오프라인 기본 페이지, 앱 아이콘              | Should   | 전체                  |

### F201: 빠른 메모

**문제**: 뉴스를 읽다가 떠오른 생각이나 할 일을 기록할 곳이 없어 별도 앱을 사용해야 한다.

**해결**: 간단한 메모 기능을 제공하여 대시보드에서 바로 메모를 작성하고 관리할 수 있게 한다.

| 항목         | 내용                                                                                                     |
| ------------ | -------------------------------------------------------------------------------------------------------- |
| **경로**     | `/protected/memos` (전체 목록), 대시보드 위젯 (최근 3~5개)                                               |
| **기능**     | 메모 작성 (제목 선택, 본문 필수), 수정, 삭제, 고정(pinned)                                               |
| **DB 변경**  | `memos` 테이블 신규 (id, user_id, title, content, is_pinned, created_at, updated_at). RLS: 본인 데이터만 |
| **대시보드** | 고정된 메모 우선 표시, 최근 순 정렬                                                                      |
| **제한**     | 메모당 최대 2000자, 사용자당 최대 200개                                                                  |

### F202: 이메일 뉴스 다이제스트

**문제**: 매번 사이트에 접속하지 않으면 뉴스를 놓친다.

**해결**: 매일 아침 사용자의 선호 카테고리를 기반으로 요약된 뉴스 다이제스트를 이메일로 발송한다.

| 항목          | 내용                                                                                |
| ------------- | ----------------------------------------------------------------------------------- |
| **발송 시간** | 매일 KST 07:00 (Vercel Cron 또는 Supabase Edge Function)                            |
| **내용**      | 선호 카테고리별 상위 3개 뉴스 그룹의 팩트 요약                                      |
| **옵트인**    | 설정 페이지에서 활성/비활성 토글                                                    |
| **발송 방법** | Supabase Auth 이메일 또는 Resend/SendGrid API                                       |
| **DB 변경**   | `user_preferences`에 `email_digest_enabled` BOOLEAN, `digest_categories` JSONB 추가 |

### F203: 뉴스 트렌드

**문제**: 지금 가장 핫한 뉴스가 무엇인지 한눈에 파악하기 어렵다.

**해결**: 최근 24시간 내 기사 수가 가장 많은 뉴스 그룹을 "트렌딩" 순위로 표시한다.

| 항목          | 내용                                                               |
| ------------- | ------------------------------------------------------------------ |
| **로직**      | `article_count` 기준 상위 10개 그룹 (최근 24시간 내 생성)          |
| **표시 위치** | 뉴스 페이지 상단에 "지금 뜨는 뉴스" 섹션, 대시보드 위젯 (상위 5개) |
| **업데이트**  | 캐시 주기와 동일 (5분 stale)                                       |
| **DB 변경**   | 없음 (기존 데이터 기반 쿼리)                                       |

---

## v2.0 기능 명세 - 라이프 데이터 통합

> **장기 목표**: Lifeboard의 핵심 비전인 "인생의 모든 데이터를 한눈에" 구현한다. 외부 서비스 연동을 통해 진정한 통합 대시보드로 확장한다.

| ID       | 기능명               | 설명                                                            | 우선순위 |
| -------- | -------------------- | --------------------------------------------------------------- | -------- |
| **F301** | Google Calendar 연동 | OAuth 로그인으로 일정 동기화, 대시보드에 오늘/이번 주 일정 표시 | Must     |
| **F302** | 할일 관리            | 체크리스트 형태의 할일 관리, 우선순위, 마감일 설정              | Must     |
| **F303** | 금융 데이터          | 주요 주가지수, 환율 실시간 표시 (공공 API 활용)                 | Should   |
| **F304** | 습관 트래커          | 일일 습관 체크 (운동, 독서 등), 주간/월간 달성률 시각화         | Could    |
| **F305** | 실시간 알림          | 속보 뉴스, 일정 리마인더 등 웹 푸시 알림                        | Should   |
| **F306** | 위젯 마켓플레이스    | 서드파티 위젯 추가 (커뮤니티 기여), 위젯 플러그인 시스템        | Could    |

---

## 데이터 모델

### 기존 테이블 (v1.0 완료)

| 테이블                | 용도                           | RLS                                   |
| --------------------- | ------------------------------ | ------------------------------------- |
| `news_sources`        | RSS 피드 소스 관리 (12개 시드) | 인증 사용자 읽기 전용                 |
| `news_articles`       | 개별 뉴스 기사                 | 인증 사용자 읽기 전용                 |
| `news_article_groups` | 중복 기사 그룹 + AI 팩트 요약  | 인증 사용자 읽기 전용                 |
| `news_fetch_logs`     | RSS 수집 로그                  | service_role만 접근                   |
| `summarize_jobs`      | AI 요약 작업 큐                | 인증 읽기+INSERT, service_role UPDATE |

### 신규 테이블 (v1.1)

```sql
-- 사용자 설정
user_preferences (
  user_id UUID PK REFERENCES auth.users(id),
  preferred_categories JSONB DEFAULT '[]',
  dashboard_config JSONB DEFAULT '{"widgets": ["news", "weather"], "order": ["news", "weather"]}',
  email_digest_enabled BOOLEAN DEFAULT false,
  weather_location TEXT DEFAULT 'seoul',
  updated_at TIMESTAMPTZ DEFAULT now()
)
-- RLS: 본인 데이터만 SELECT, INSERT, UPDATE

-- 뉴스 북마크
user_bookmarks (
  id UUID PK DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  group_id UUID REFERENCES news_article_groups(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(user_id, group_id)
)
-- RLS: 본인 데이터만 SELECT, INSERT, DELETE
-- 제한: 사용자당 최대 100개 (API Route에서 INSERT 전 COUNT 체크)

-- 콘텐츠 필터 설정 (F113)
content_filters (
  id UUID PK DEFAULT gen_random_uuid(),
  filter_type TEXT NOT NULL, -- 'blacklist' | 'whitelist'
  keywords TEXT[] NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
)
-- RLS: 모든 인증 사용자 읽기 전용, service_role만 수정

-- 관리자 활동 로그 (F120)
admin_audit_logs (
  id UUID PK DEFAULT gen_random_uuid(),
  admin_id UUID REFERENCES auth.users(id) NOT NULL,
  action TEXT NOT NULL,           -- 'update_role' | 'toggle_source' | 'hide_group' | 'rerun_summary' | 'update_filter' | 'ban_user' ...
  target_type TEXT NOT NULL,      -- 'user' | 'news_source' | 'news_group' | 'news_article' | 'content_filter' | 'summarize_job'
  target_id TEXT,                 -- 대상 레코드 ID
  details JSONB DEFAULT '{}',     -- 변경 전후 값 등 상세 정보
  created_at TIMESTAMPTZ DEFAULT now()
)
-- RLS: 관리자만 SELECT, service_role INSERT
-- 인덱스: admin_id, created_at DESC
```

### 테이블 변경 (v1.1)

```sql
-- news_article_groups에 품질 플래그 추가 (F111)
alter table news_article_groups
  add column is_valid boolean default true;

create index idx_news_article_groups_is_valid
  on news_article_groups(is_valid)
  where is_valid = true;

-- news_fetch_logs에 필터링 카운트 추가 (F113)
alter table news_fetch_logs
  add column filtered_count integer default 0;

-- news_sources에 활성 상태 추가 (F122, 이미 있으면 생략)
-- alter table news_sources
--   add column is_active boolean default true;

-- news_articles에 soft delete 추가 (F122)
alter table news_articles
  add column is_deleted boolean default false;
```

### 신규 테이블 (v1.2)

```sql
-- 메모
memos (
  id UUID PK DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  title TEXT,
  content TEXT NOT NULL,
  is_pinned BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
)
-- RLS: 본인 데이터만 CRUD
```

### 기존 RPC 함수 (v1.0)

| 함수명                        | 용도                                     |
| ----------------------------- | ---------------------------------------- |
| `find_similar_group`          | 트라이그램 유사도 기반 그룹 검색         |
| `increment_article_count`     | 그룹 기사 수 갱신                        |
| `cleanup_old_records`         | 90일 로그 + 30일 완료 작업 자동 삭제     |
| `enqueue_summarize_jobs`      | pending 작업 일괄 등록                   |
| `get_top_articles_for_groups` | 그룹별 상위 N개 기사 조회 (윈도우 함수)  |
| `batch_group_articles`        | 배치 그룹핑 (유사도 기반, 단일 트랜잭션) |

---

## 메뉴 구조 (v1.1 목표)

```
Lifeboard 네비게이션

비로그인:
├── 홈 (/) - "시작하기" → /auth/login
└── 로그인 (/auth/login) - 소셜 로그인 버튼 (Google, Kakao)
    └── /auth/callback - OAuth 콜백 처리 (내부)

로그인 후:
├── 대시보드 (/protected)
│   ├── 뉴스 위젯 (최신 6개 카드 - 대표이미지 + 제목, F108)
│   │   └── 카드 클릭 → 뉴스 상세 페이지 (F109)
│   ├── 날씨 위젯 (v1.1, F104)
│   └── 북마크 위젯 (v1.1, F102)
├── 뉴스 (/protected/news)
│   ├── 간소화된 카드 목록 (F108)
│   ├── 검색 (v1.1, F101)
│   ├── 카테고리 필터
│   ├── 북마크 탭 (v1.1, F102)
│   ├── 페이지네이션
│   └── 카드 클릭 → 뉴스 상세 (/protected/news/[groupId], F109)
│       ├── 통일된 팩트 요약 폼 (F110)
│       ├── 관련 기사 전체 목록
│       ├── 북마크 버튼 (F102)
│       └── 공유 버튼 (F106)
├── 날씨 (/protected/weather) (v1.1, F104)
├── 설정 (/protected/settings) (v1.1, F103)
│   ├── 프로필 (소셜 계정 정보)
│   ├── 선호 카테고리
│   └── 대시보드 위젯 설정 (F107)
├── 로그아웃
│
└── [관리자 전용] (role === 'admin'일 때만 표시)
    관리자 패널 (/admin) - 별도 사이드바 레이아웃
    ├── 대시보드 (/admin)
    │   ├── 시스템 개요 카드 (사용자 수, 기사 수, 요약 현황)
    │   ├── 파이프라인 상태 (수집/요약 성공률)
    │   ├── 품질 지표 (무효 요약, 평균 그룹 기사 수)
    │   └── 최근 활동 로그
    ├── 뉴스 관리 (/admin/news)
    │   ├── 소스 관리 탭 (CRUD + 활성/비활성 토글)
    │   ├── 그룹 관리 탭 (숨김/노출, 요약 재실행, 일괄 작업)
    │   └── 기사 관리 탭 (검색, 삭제, 그룹 이동)
    ├── 콘텐츠 모더레이션 (/admin/moderation)
    │   ├── 필터 관리 탭 (블랙리스트/화이트리스트 CRUD, 테스트)
    │   └── 품질 검토 탭 (검토 큐, 승인/거부, 재요약)
    ├── 사용자 관리 (/admin/users)
    │   ├── 사용자 목록 (검색, 페이지네이션)
    │   ├── 역할 변경 (user ↔ admin)
    │   └── 계정 상태 관리 (활성/정지)
    ├── 시스템 모니터링 (/admin/monitoring)
    │   ├── 수집 로그 탭 (소스별/날짜별 필터)
    │   ├── 요약 작업 탭 (상태별 필터, 재시도/리셋)
    │   └── 시스템 상태 탭 (파이프라인, 워커, DB)
    └── 사이트로 돌아가기 → /protected
```

---

## 뉴스 수집 파이프라인 (현재 구현)

### 수집 흐름

1. **Vercel Cron 트리거** - 하루 2회 (KST 08:00, 20:00 = UTC 23:00, 11:00)
2. **RSS 피드 병렬 수집** - `rss-parser`로 12개 소스 병렬 fetch, 5초 타임아웃
3. **제목 정규화** - `[속보]`/`[단독]` 태그 제거, 특수문자 정리, 소문자 변환
4. **DB INSERT** - `UNIQUE(source_id, guid)` 제약으로 중복 방지, 23505 에러 핸들링
5. **배치 그룹핑** - `batch_group_articles` RPC (트라이그램 유사도 0.6, 48시간 범위, 단일 트랜잭션)
6. **수집 로그 기록** - `news_fetch_logs`에 소스별 결과 기록
7. **요약 작업 등록** - `enqueue_summarize_jobs` RPC로 pending 작업 일괄 생성
8. **캐시 무효화** - `updateTag('news-groups')`, `updateTag('news-group-articles')` 호출

### 데이터 소스 (한국 주요 언론사 RSS)

네이버 뉴스 RSS는 2023년 서비스 종료. 직접 언론사 RSS 피드 활용 (API 키 불필요, 무료).

| 카테고리 | 언론사   | RSS URL                                             |
| -------- | -------- | --------------------------------------------------- |
| politics | 경향신문 | https://www.khan.co.kr/rss/rssdata/politic_news.xml |
| politics | 연합뉴스 | http://www.yonhapnews.co.kr/RSS/politics.xml        |
| economy  | 경향신문 | https://www.khan.co.kr/rss/rssdata/economy_news.xml |
| economy  | 연합뉴스 | http://www.yonhapnews.co.kr/RSS/economy.xml         |
| economy  | 한국경제 | https://www.hankyung.com/feed/all-news              |
| society  | 경향신문 | https://www.khan.co.kr/rss/rssdata/society_news.xml |
| society  | 연합뉴스 | http://www.yonhapnews.co.kr/RSS/society.xml         |
| culture  | 경향신문 | https://www.khan.co.kr/rss/rssdata/culture_news.xml |
| culture  | 연합뉴스 | http://www.yonhapnews.co.kr/RSS/culture.xml         |
| science  | 경향신문 | https://www.khan.co.kr/rss/rssdata/science_news.xml |
| science  | 전자신문 | https://www.etnews.com/rss/Section901.xml           |
| world    | 경향신문 | https://www.khan.co.kr/rss/rssdata/kh_world.xml     |
| world    | 연합뉴스 | http://www.yonhapnews.co.kr/RSS/international.xml   |

### Ollama PC 워커

```
scripts/                        (독립 패키지, tsconfig.json exclude 포함)
├── worker.ts                   메인 워커 (Realtime + 30초 폴링)
├── summarizer.ts               Ollama 팩트 추출 (120초 타임아웃, 3회 재시도)
├── package.json                독립 의존성
├── tsconfig.json               독립 설정
├── .env.example                환경 변수 템플릿
└── README.md                   설정 가이드
```

### 팩트 추출 프롬프트 (F111 반영)

```
당신은 팩트 체커입니다. 아래 뉴스 기사들을 분석하여 다음 규칙을 따라 정리해주세요:

**CRITICAL: 반드시 한국어로만 작성하세요. 절대로 다른 언어(영어, 중국어, 일본어 등)를 섞지 마세요.**

1. 검증 가능한 사실(팩트)만 추출하세요
2. 기자, 전문가, 관계자의 의견/전망/추측은 제외하세요
3. "~할 것으로 보인다", "~할 전망이다", "~라는 분석이다" 등 추측성 표현은 제외하세요
4. 여러 기사에서 공통으로 언급된 사실을 우선 포함하세요
5. 숫자, 날짜, 인물, 기관명 등 구체적 정보를 포함하세요
6. 3~5개 핵심 팩트를 불릿 포인트로 정리하세요
7. **모든 응답은 한국어로만 작성하세요**

[뉴스 그룹 내 기사 제목 + 요약 목록]
```

### 콘텐츠 필터링 규칙 (F113)

| 항목             | 값                                                                                                                    |
| ---------------- | --------------------------------------------------------------------------------------------------------------------- |
| **블랙리스트**   | `["결혼", "이혼", "열애", "임신", "출산", "부고", "장례", "일상", "근황", "데이트", "SNS", "인스타", "패션", "공항"]` |
| **화이트리스트** | `["속보", "긴급", "공식", "발표", "확정"]`                                                                            |
| **필터링 로직**  | 제목에 블랙리스트 키워드가 있고, 화이트리스트 키워드가 없으면 수집 제외                                               |
| **적용 시점**    | RSS 수집 API (`/api/news/collect`), DB INSERT 전                                                                      |
| **관리**         | `content_filters` 테이블로 관리, 관리자 콘텐츠 모더레이션(F123)에서 수정 가능                                         |

---

## 환경 변수

### Vercel (웹앱)

```bash
NEXT_PUBLIC_SUPABASE_URL=<supabase-project-url>
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=<supabase-publishable-key>
SUPABASE_SERVICE_ROLE_KEY=<service-role-key>    # 서버 전용, 클라이언트 노출 금지
CRON_SECRET=<랜덤-시크릿>                        # Vercel Cron 인증용
SLACK_WEBHOOK_URL=<slack-webhook-url>            # 훅 알림용 (선택)
WEATHER_API_KEY=<기상청-또는-openweather-key>    # v1.1 날씨 위젯용
```

### Ollama PC (scripts/.env)

```bash
SUPABASE_URL=<supabase-project-url>
SUPABASE_SERVICE_ROLE_KEY=<service-role-key>     # RLS 우회
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=qwen2.5:14b
```

---

## 현재 시스템의 개선 필요 영역

MVP를 운영하면서 발견된 개선점과 사용자 경험 측면의 부족한 부분이다. **2026-02-16 사용자 피드백 반영 (ISSUE.md)**.

### 뉴스 시스템

| 영역             | 현재 상태                           | 개선 방향                                                        |
| ---------------- | ----------------------------------- | ---------------------------------------------------------------- |
| **UI/UX**        | 카드에 모든 정보 표시, 정보 과부하  | 목록은 대표이미지 + 제목만, 상세 페이지 분리 (F108, F109)        |
| **팩트 요약 폼** | 카드마다 다른 포맷, 가독성 저하     | 통일된 디자인 시스템 적용 (F110)                                 |
| **AI 요약 품질** | 중국어 혼용, 품질 저하 케이스 존재  | 한국어 전용 프롬프트 + 품질 검증 + 실패 시 숨김 (F111)           |
| **그룹핑 효과**  | 대부분 1개 기사만, 그룹핑 의미 없음 | 유사도 임계값 조정 (0.6→0.5) + 소스 확대 + 시간 범위 확대 (F112) |
| **콘텐츠 품질**  | 연예/경조사 등 불필요 기사 혼재     | 키워드 블랙리스트 필터링 (F113)                                  |
| **검색**         | 카테고리 필터와 페이지네이션만 존재 | 전문 검색 (FTS/trgm) 추가 (F101)                                 |
| **저장**         | 관심 기사 저장 불가                 | 북마크 기능 추가 (F102)                                          |
| **공유**         | 수동 복사만 가능                    | 요약 텍스트/링크 복사 버튼 (F106)                                |
| **트렌드**       | 최신순 정렬만 제공                  | 보도 빈도 기반 트렌딩 순위 (F203)                                |
| **RSS 관리**     | DB 직접 수정 필요                   | UI에서 소스 관리 (F105)                                          |
| **수집 빈도**    | 하루 2회 (Vercel Hobby 제한)        | Pro 업그레이드 시 6회 (4시간 간격) 가능                          |
| **해외 뉴스**    | 한국 언론사만                       | Reuters, AP News 등 추가 (F204)                                  |

### 플랫폼

| 영역            | 현재 상태                            | 개선 방향                                  |
| --------------- | ------------------------------------ | ------------------------------------------ |
| **인증**        | 이메일/비밀번호만 지원, 가입 마찰 큼 | 소셜 로그인 전환, 이메일 인증 제거 (F100)  |
| **대시보드**    | 뉴스 섹션만 존재                     | 날씨, 메모 등 다중 위젯 (F104, F107, F201) |
| **개인화**      | 모든 사용자 동일 경험                | 선호 카테고리, 위젯 설정 (F103)            |
| **사용자 설정** | 프로필/설정 페이지 없음              | 설정 페이지 추가 (F103)                    |
| **알림**        | 없음                                 | 이메일 다이제스트 (F202), 웹 푸시 (F305)   |
| **모바일**      | 반응형 웹만                          | PWA 지원 (F205)                            |

### 운영/관리

| 영역            | 현재 상태                              | 개선 방향                                   |
| --------------- | -------------------------------------- | ------------------------------------------- |
| **관리자 역할** | 역할 구분 없음, 모든 사용자 동일 권한  | 관리자 역할 시스템 + 라우트/API 보호 (F120) |
| **운영 현황**   | Supabase/Vercel 대시보드에서 개별 확인 | 통합 관리자 대시보드 (F121)                 |
| **뉴스 운영**   | DB 직접 수정으로만 소스/그룹/기사 관리 | 관리자 뉴스 관리 UI (F122)                  |
| **콘텐츠 관리** | 필터/품질 관리 UI 없음                 | 콘텐츠 모더레이션 페이지 (F123)             |
| **사용자 관리** | Supabase 대시보드에서만 확인 가능      | 관리자 사용자 관리 페이지 (F124)            |
| **시스템 감시** | 로그/에러 파악 어려움                  | 통합 시스템 모니터링 (F125)                 |

---

## 우선순위 매트릭스 (v1.1 기준)

> **범위 축소 권장**: 1인 개발 프로젝트로서 v1.1의 범위가 과도하게 넓다. 아래 단계별 분리를 강력히 권장한다.

### 권장 구현 단계

| 단계  | 포함 기능                          | 핵심 목표                         |
| ----- | ---------------------------------- | --------------------------------- |
| v1.1a | F108, F109, F110, F111, F112, F113 | 뉴스 UX 개선 (사용자 피드백 반영) |
| v1.1b | F100, F101, F102, F103, F106       | 소셜 로그인 + 검색/북마크/설정    |
| v1.1c | F120, F121, F122                   | 관리자 시스템 핵심                |
| v1.1d | F104, F107, F123, F124, F125       | 날씨 + 위젯 + 관리자 확장         |

### 기능별 복잡도 및 의존성

| 기능                    | ID   | 우선순위 | 복잡도   | 의존성           | 비고                                       |
| ----------------------- | ---- | -------- | -------- | ---------------- | ------------------------------------------ |
| **뉴스 카드 UI 간소화** | F108 | Must     | 낮음     | 없음             | **사용자 피드백 최우선**, UI 개편          |
| **뉴스 상세 페이지**    | F109 | Must     | 중간     | F108             | **사용자 피드백**, 상세 라우트 신규        |
| **통일된 팩트 요약 폼** | F110 | Must     | 낮음     | F109             | **사용자 피드백**, 디자인 시스템 통일      |
| **AI 요약 품질 관리**   | F111 | Must     | 중간     | 없음             | **사용자 피드백**, 한국어 전용 + 품질 검증 |
| 그룹핑 시스템 개선      | F112 | Should   | 중간     | 없음             | 사용자 피드백, 유사도 조정 + 소스 확대     |
| 콘텐츠 필터링           | F113 | Should   | 낮음     | 없음             | 사용자 피드백, 블랙리스트 필터링           |
| **소셜 로그인**         | F100 | Must     | 높음     | 없음             | Google/Kakao 2개. Naver는 v1.2로 이관      |
| 뉴스 검색               | F101 | Must     | 중간     | 없음             | pg_trgm ILIKE (한국어 FTS 미지원)          |
| 뉴스 북마크             | F102 | Must     | 중간     | F100             | 사용자 식별 필요                           |
| 사용자 설정 페이지      | F103 | Must     | 중간     | F100             | 소셜 프로필 정보 표시                      |
| 날씨 위젯               | F104 | Should   | 중간     | F103             | OpenWeatherMap 사용 시 복잡도 낮아짐       |
| 뉴스 소스 관리          | F105 | Should   | -        | F122             | **F122에 통합**, 별도 구현 불필요          |
| 뉴스 공유               | F106 | Could    | 낮음     | F109             | 상세 페이지에서 제공                       |
| 대시보드 위젯 시스템    | F107 | Should   | **낮음** | F103             | v1.1은 토글만, 드래그앤드롭은 v1.2로 이관  |
| **관리자 역할 시스템**  | F120 | Must     | 중간     | F100             | 관리자 기능의 기반, 소셜 로그인 후 구현    |
| **관리자 대시보드**     | F121 | Must     | 중간     | F120             | 운영 필수, 차트는 shadcn/ui charts 사용    |
| **뉴스 관리**           | F122 | Must     | 높음     | F120             | F105 통합, F111 관리 UI 통합               |
| 콘텐츠 모더레이션       | F123 | Should   | 중간     | F120, F111, F113 | F111, F113 관리 UI                         |
| 사용자 관리             | F124 | Should   | 중간     | F120             | 사용자 수 증가 시 필수                     |
| 시스템 모니터링         | F125 | Should   | 중간     | F120             | 장애 대응에 필수                           |

---

## 변경 이력

| 날짜       | 버전 | 변경 내용                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ---------- | ---- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2026-02-14 | 1.0  | 초기 PRD 생성 (MVP 기능 명세)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 2026-02-16 | 2.0  | MVP 완료 반영, 기술 스택 현행화, v1.1/v1.2/v2.0 기능 명세 추가, 개선점 정리                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| 2026-02-16 | 2.1  | F100 소셜 로그인(Google/Kakao/Naver/Apple) 추가, 이메일/비밀번호 인증 제거 계획 반영                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| 2026-02-16 | 2.2  | **사용자 피드백 반영 (ISSUE.md)**: F108~F113 신규 기능 추가<br>- F108: 뉴스 카드 UI 간소화 (대표이미지 + 제목)<br>- F109: 뉴스 상세 페이지 (`/protected/news/[groupId]`)<br>- F110: 통일된 팩트 요약 폼<br>- F111: AI 요약 품질 관리 (한국어 전용 + 품질 검증)<br>- F112: 그룹핑 시스템 개선 (유사도 0.5, 소스 확대)<br>- F113: 콘텐츠 필터링 (블랙리스트 키워드)<br>사용자 여정, 라우팅 구조, 데이터 모델, 메뉴 구조, 우선순위 매트릭스 업데이트                                                                                                                         |
| 2026-02-16 | 2.3  | **관리자 시스템 추가 (F120~F125)**:<br>- F120: 관리자 역할 시스템 (Supabase custom claims 기반, 라우트/API 보호)<br>- F121: 관리자 대시보드 (시스템 현황, 파이프라인 상태, 품질 지표)<br>- F122: 뉴스 관리 (소스 CRUD, 그룹 숨김/노출, 요약 재실행, 기사 관리)<br>- F123: 콘텐츠 모더레이션 (필터 규칙 관리 UI, 품질 검토 큐)<br>- F124: 사용자 관리 (목록 조회, 역할 변경, 계정 상태 관리)<br>- F125: 시스템 모니터링 (수집 로그, 요약 작업, 워커 상태)<br>`/admin/*` 라우팅, `admin_audit_logs` 테이블, 관리자 사이드바 레이아웃, 메뉴 구조, 우선순위 매트릭스 업데이트 |
| 2026-02-16 | 2.4  | **기술 검증 반영**: Naver OAuth v1.2로 이관 (OIDC 미지원), F100을 3개 프로바이더로 축소, 기존 사용자 마이그레이션 전략 추가, PostgreSQL 한국어 FTS를 pg_trgm ILIKE로 대체, proxy.ts getClaims() 이중 호출 방지, isAdmin() getSession을 getClaims로 변경, F105를 F122에 통합, F107 드래그앤드롭 v1.2로 이관, news-group-card.tsx 파일명 수정, user_bookmarks FK CASCADE 추가, F108 이미지 폴백 전략 명시, F111 프론트엔드 쿼리 변경 범위 명시, F112 RPC 시그니처 수정, v1.1 단계별 분리 권장 (v1.1a~d), F121 차트에 shadcn/ui charts 사용 명시, F104 OpenWeatherMap 권장   |
